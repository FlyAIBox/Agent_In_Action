<svg viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: 'SimSun', serif; font-size: 26px; font-weight: bold; fill: #1a1a1a; }
      .subtitle { font-family: 'SimSun', serif; font-size: 15px; fill: #333; }
      .label-cn { font-family: 'SimSun', serif; font-size: 13px; fill: #2c3e50; }
      .label-en { font-family: 'Times New Roman', serif; font-size: 11px; fill: #555; font-style: italic; }
      .formula { font-family: 'Times New Roman', serif; font-size: 12px; fill: #c0392b; font-style: italic; }
      .node { fill: #ecf0f1; stroke: #34495e; stroke-width: 2; }
      .node-start { fill: #2ecc71; stroke: #27ae60; stroke-width: 2; }
      .node-coord { fill: #3498db; stroke: #2980b9; stroke-width: 2; }
      .node-agent { fill: #e74c3c; stroke: #c0392b; stroke-width: 2; }
      .node-tool { fill: #f39c12; stroke: #d68910; stroke-width: 2; }
      .node-end { fill: #9b59b6; stroke: #8e44ad; stroke-width: 2; }
      .arrow { stroke: #34495e; stroke-width: 2.5; fill: none; marker-end: url(#arrowhead); }
      .arrow-condition { stroke: #e74c3c; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); stroke-dasharray: 5,3; }
      .code-bg { fill: #f8f9fa; stroke: #dee2e6; stroke-width: 1; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
    </marker>
    <filter id="shadow">
      <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.3"/>
    </filter>
  </defs>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">LangGraph智能体协作工作流</text>
  <text x="700" y="58" text-anchor="middle" class="subtitle">Multi-Agent Orchestration with LangGraph StateGraph</text>

  <!-- State Definition Section -->
  <rect x="40" y="80" width="450" height="180" class="code-bg" rx="8" filter="url(#shadow)"/>
  <text x="60" y="105" class="label-cn" font-weight="bold">状态图核心概念 (StateGraph Core Concepts)</text>
  
  <text x="60" y="135" class="label-cn" font-weight="bold">状态结构:</text>
  <text x="80" y="158" class="formula" font-size="13">State = {</text>
  <text x="100" y="178" class="formula">  messages: List[BaseMessage],</text>
  <text x="100" y="195" class="formula">  agent_outputs: Dict[str, Any],</text>
  <text x="100" y="212" class="formula">  context: Dict[str, Any]</text>
  <text x="80" y="229" class="formula">}</text>
  <text x="60" y="250" class="label-en">State updates are immutable; each node returns modified state</text>

  <!-- Message Flow Formula -->
  <rect x="530" y="80" width="450" height="180" class="code-bg" rx="8" filter="url(#shadow)"/>
  <text x="550" y="105" class="label-cn" font-weight="bold">消息传递机制 (Message Passing)</text>
  
  <text x="550" y="135" class="label-cn">节点间通信公式:</text>
  <text x="570" y="160" class="formula" font-size="14">Output_i = f_i(State_{i-1}, Tools)</text>
  <text x="570" y="185" class="formula" font-size="14">State_i = State_{i-1} ⊕ Output_i</text>
  <text x="550" y="210" class="label-cn" font-size="11">其中 ⊕ 表示状态合并操作 (merge operation)</text>
  <text x="550" y="230" class="label-en">Each agent node processes previous state and tools,</text>
  <text x="550" y="245" class="label-en">producing outputs that merge into global state</text>

  <!-- Workflow Diagram -->
  <text x="700" y="300" text-anchor="middle" class="label-cn" font-weight="bold" font-size="16">工作流执行序列图</text>

  <!-- START Node -->
  <rect x="630" y="330" width="140" height="60" class="node-start" rx="10" filter="url(#shadow)"/>
  <text x="700" y="355" text-anchor="middle" class="label-cn" fill="white" font-weight="bold" font-size="15">START</text>
  <text x="700" y="375" text-anchor="middle" class="label-en" fill="white">Initialize State</text>

  <!-- Coordinator Node -->
  <rect x="630" y="430" width="140" height="70" class="node-coord" rx="10" filter="url(#shadow)"/>
  <text x="700" y="455" text-anchor="middle" class="label-cn" fill="white" font-weight="bold">协调员节点</text>
  <text x="700" y="473" text-anchor="middle" class="label-en" fill="white" font-size="10">Coordinator Agent</text>
  <text x="700" y="490" text-anchor="middle" class="label-cn" fill="white" font-size="11">分析需求并调度</text>

  <!-- Decision Diamond -->
  <path d="M 700 540 L 750 570 L 700 600 L 650 570 Z" fill="#f39c12" stroke="#d68910" stroke-width="2" filter="url(#shadow)"/>
  <text x="700" y="575" text-anchor="middle" class="label-cn" font-size="11" font-weight="bold">需要工具?</text>

  <!-- Tools Node -->
  <rect x="480" y="640" width="140" height="70" class="node-tool" rx="10" filter="url(#shadow)"/>
  <text x="550" y="665" text-anchor="middle" class="label-cn" fill="white" font-weight="bold">工具节点</text>
  <text x="550" y="683" text-anchor="middle" class="label-en" fill="white" font-size="10">Tools Node</text>
  <text x="550" y="700" text-anchor="middle" class="label-cn" fill="white" font-size="11">调用外部API</text>

  <!-- Agent Nodes -->
  <rect x="780" y="640" width="140" height="70" class="node-agent" rx="10" filter="url(#shadow)"/>
  <text x="850" y="700" text-anchor="middle" class="label-cn" fill="white" font-size="11">生成专业建议</text>

  <!-- Expert Agents Detail -->
  <g transform="translate(1020, 320)">
    <rect x="0" y="0" width="350" height="420" class="code-bg" rx="8" filter="url(#shadow)"/>
    <text x="15" y="25" class="label-cn" font-weight="bold">专家智能体详解 (Expert Agents)</text>
    
    <!-- Travel Advisor -->
    <circle cx="80" cy="70" r="28" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
    <text x="80" y="75" text-anchor="middle" class="label-cn" fill="white" font-size="10" font-weight="bold">旅行顾问</text>
    <text x="130" y="70" class="label-en" font-size="10">Travel Advisor</text>
    <text x="130" y="85" class="label-cn" font-size="9">• 目的地分析</text>
    
    <!-- Weather Analyst -->
    <circle cx="80" cy="140" r="28" fill="#f39c12" stroke="#d68910" stroke-width="2"/>
    <text x="80" y="145" text-anchor="middle" class="label-cn" fill="white" font-size="10" font-weight="bold">天气分析</text>
    <text x="130" y="140" class="label-en" font-size="10">Weather Analyst</text>
    <text x="130" y="155" class="label-cn" font-size="9">• 气候预报</text>
    
    <!-- Budget Optimizer -->
    <circle cx="80" cy="210" r="28" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/>
    <text x="80" y="215" text-anchor="middle" class="label-cn" fill="white" font-size="10" font-weight="bold">预算优化</text>
    <text x="130" y="210" class="label-en" font-size="10">Budget Optimizer</text>
    <text x="130" y="225" class="label-cn" font-size="9">• 费用规划</text>
    
    <!-- Local Expert -->
    <circle cx="80" cy="280" r="28" fill="#9b59b6" stroke="#8e44ad" stroke-width="2"/>
    <text x="80" y="285" text-anchor="middle" class="label-cn" fill="white" font-size="10" font-weight="bold">当地专家</text>
    <text x="130" y="280" class="label-en" font-size="10">Local Expert</text>
    <text x="130" y="295" class="label-cn" font-size="9">• 文化建议</text>
    
    <!-- Itinerary Planner -->
    <circle cx="80" cy="350" r="28" fill="#1abc9c" stroke="#16a085" stroke-width="2"/>
    <text x="80" y="355" text-anchor="middle" class="label-cn" fill="white" font-size="10" font-weight="bold">行程规划</text>
    <text x="130" y="350" class="label-en" font-size="10">Itinerary Planner</text>
    <text x="130" y="365" class="label-cn" font-size="9">• 日程安排</text>
    
    <text x="15" y="395" class="formula" font-size="11">Agent_Score = Σ(Quality_i × Weight_i)</text>
    <text x="15" y="410" class="label-en" font-size="9">Each agent contributes weighted outputs</text>
  </g>

  <!-- Back to Coordinator -->
  <rect x="630" y="750" width="140" height="70" class="node-coord" rx="10" filter="url(#shadow)"/>
  <text x="700" y="775" text-anchor="middle" class="label-cn" fill="white" font-weight="bold">协调员汇总</text>
  <text x="700" y="793" text-anchor="middle" class="label-en" fill="white" font-size="10">Coordinator Review</text>
  <text x="700" y="810" text-anchor="middle" class="label-cn" fill="white" font-size="11">评估完整性</text>

  <!-- Completion Check -->
  <path d="M 700 860 L 750 890 L 700 920 L 650 890 Z" fill="#2ecc71" stroke="#27ae60" stroke-width="2" filter="url(#shadow)"/>
  <text x="700" y="895" text-anchor="middle" class="label-cn" font-size="11" font-weight="bold">完成?</text>

  <!-- END Node -->
  <rect x="630" y="950" width="140" height="50" class="node-end" rx="10" filter="url(#shadow)"/>
  <text x="700" y="978" text-anchor="middle" class="label-cn" fill="white" font-weight="bold" font-size="15">END</text>

  <!-- Arrows -->
  <path d="M 700 390 L 700 430" class="arrow"/>
  <path d="M 700 500 L 700 540" class="arrow"/>
  
  <!-- Decision arrows -->
  <path d="M 650 570 L 550 640" class="arrow-condition"/>
  <text x="590" y="600" class="label-cn" font-size="10" fill="#e74c3c">是</text>
  
  <path d="M 750 570 L 850 640" class="arrow-condition"/>
  <text x="810" y="600" class="label-cn" font-size="10" fill="#e74c3c">否</text>
  
  <!-- Return arrows -->
  <path d="M 550 710 L 700 750" class="arrow"/>
  <path d="M 850 710 L 700 750" class="arrow"/>
  
  <path d="M 700 820 L 700 860" class="arrow"/>
  
  <!-- Loop back -->
  <path d="M 650 890 L 580 890 L 580 470 L 630 470" class="arrow-condition"/>
  <text x="550" y="680" class="label-cn" font-size="10" fill="#e74c3c">需继续</text>
  
  <!-- Final arrow -->
  <path d="M 700 920 L 700 950" class="arrow"/>
  <text x="720" y="940" class="label-cn" font-size="10" fill="#2ecc71">完成</text>

  <!-- Tools Detail Box -->
  <rect x="40" y="320" width="420" height="400" class="code-bg" rx="8" filter="url(#shadow)"/>
  <text x="60" y="345" class="label-cn" font-weight="bold" font-size="14">工具调用机制 (Tool Invocation)</text>
  
  <!-- DuckDuckGo -->
  <rect x="60" y="365" width="380" height="60" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="5"/>
  <text x="75" y="385" class="label-cn" font-weight="bold">🔍 DuckDuckGo搜索</text>
  <text x="75" y="405" class="label-en" font-size="10">search_destination(query: str) → List[Result]</text>
  <text x="75" y="420" class="label-cn" font-size="10">无需API密钥，提供实时信息检索</text>
  
  <!-- MCP Weather -->
  <rect x="60" y="435" width="380" height="60" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="5"/>
  <text x="75" y="455" class="label-cn" font-weight="bold">🌤️ MCP天气服务器</text>
  <text x="75" y="475" class="label-en" font-size="10">get_weather_forecast(city: str, days: int) → Weather</text>
  <text x="75" y="490" class="label-cn" font-size="10">集成QWeather API，结构化天气数据</text>
  
  <!-- Tool Response -->
  <rect x="60" y="505" width="380" height="80" fill="#fff" stroke="#dee2e6" stroke-width="1" rx="5"/>
  <text x="75" y="525" class="label-cn" font-weight="bold">工具响应格式</text>
  <text x="85" y="547" class="formula" font-size="11">ToolResult = {</text>
  <text x="100" y="563" class="formula" font-size="11">  success: bool,</text>
  <text x="100" y="577" class="formula" font-size="11">  data: Any | None,</text>
  <text x="85" y="591" class="formula" font-size="11">}</text>
  
  <!-- Retry Strategy -->
  <rect x="60" y="595" width="380" height="110" fill="#fff3cd" stroke="#ffc107" stroke-width="2" rx="5"/>
  <text x="75" y="615" class="label-cn" font-weight="bold">⚠️ 容错与重试策略</text>
  <text x="85" y="635" class="formula" font-size="11">Retry_Count = min(3, ⌈log₂(timeout)⌉)</text>
  <text x="75" y="655" class="label-cn" font-size="10">• 指数退避: delay = 2^n × base_delay</text>
  <text x="75" y="670" class="label-cn" font-size="10">• 失败降级: 使用模拟数据 (Mock Data)</text>
  <text x="75" y="685" class="label-cn" font-size="10">• 超时控制: asyncio.wait_for(task, timeout=300)</text>

  <!-- Performance Metrics -->
  <rect x="40" y="760" width="420" height="210" class="code-bg" rx="8" filter="url(#shadow)"/>
  <text x="60" y="785" class="label-cn" font-weight="bold" font-size="14">性能指标与优化 (Performance Metrics)</text>
  
  <text x="60" y="815" class="label-cn" font-weight="bold">执行时间分解:</text>
  <text x="75" y="837" class="formula" font-size="12">T_total = T_coord + Σ(T_agent_i) + Σ(T_tool_j)</text>
  <text x="60" y="860" class="label-cn" font-size="10">其中 T_coord: 协调时间, T_agent: 智能体推理时间, T_tool: 工具调用时间</text>
  
  <text x="60" y="885" class="label-cn" font-weight="bold">并行化优势:</text>
  <text x="75" y="907" class="formula" font-size="12">Speedup = T_sequential / T_parallel ≈ n / (1 + f)</text>
  <text x="60" y="930" class="label-cn" font-size="10">n: 并行任务数, f: 串行比例 (Amdahl's Law)</text>
  
  <text x="60" y="955" class="label-cn" font-size="10">✓ 目标: 平均规划时长 ≤ 180秒</text>
  <text x="60" y="970" class="label-cn" font-size="10">✓ 超时回退: SimpleTravelAgent 提供快速方案</text>

  <!-- Legend -->
  <rect x="1020" y="780" width="350" height="190" class="code-bg" rx="8" filter="url(#shadow)"/>
  <text x="1040" y="805" class="label-cn" font-weight="bold" font-size="14">图例说明 (Legend)</text>
  
  <rect x="1040" y="820" width="25" height="20" class="node-start" rx="3"/>
  <text x="1075" y="835" class="label-cn" font-size="11">启动/初始化节点</text>
  
  <rect x="1040" y="850" width="25" height="20" class="node-coord" rx="3"/>
  <text x="1075" y="865" class="label-cn" font-size="11">协调员节点</text>
  
  <rect x="1040" y="880" width="25" height="20" class="node-agent" rx="3"/>
  <text x="1075" y="895" class="label-cn" font-size="11">专家智能体节点</text>
  
  <rect x="1040" y="910" width="25" height="20" class="node-tool" rx="3"/>
  <text x="1075" y="925" class="label-cn" font-size="11">工具调用节点</text>
  
  <rect x="1040" y="940" width="25" height="20" class="node-end" rx="3"/>
  <text x="1075" y="955" class="label-cn" font-size="11">结束节点</text>
  
  <line x1="1220" y1="830" x2="1260" y2="830" class="arrow"/>
  <text x="1270" y="835" class="label-cn" font-size="11">确定流向</text>
  
  <line x1="1220" y1="860" x2="1260" y2="860" class="arrow-condition"/>
  <text x="1270" y="865" class="label-cn" font-size="11">条件分支</text>
</svg>="665" text-anchor="middle" class="label-cn" fill="white" font-weight="bold">专家节点</text>
  <text x="850" y="683" text-anchor="middle" class="label-en" fill="white" font-size="10">Expert Agents</text>
  <text x="850" y