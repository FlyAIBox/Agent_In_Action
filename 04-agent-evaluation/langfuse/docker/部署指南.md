# Langfuse Docker Compose 部署指南

> **适用场景**: 本地开发、测试环境、小规模生产环境
> 
> **目标读者**: 大模型智能体评估中高级学习者
> 
> **版本**: Langfuse v3 / Docker Compose

---

## 📋 目录

- [系统概述](#系统概述)
- [前置要求](#前置要求)
- [快速开始](#快速开始)
  - [步骤 5: 创建用户、组织和项目](#步骤-5-创建用户组织和项目)
  - [步骤 6: 获取 API 密钥](#步骤-6-获取-api-密钥)
- [详细配置说明](#详细配置说明)
- [安全加固](#安全加固)
- [常见问题](#常见问题)
- [性能优化](#性能优化)
- [数据备份与恢复](#数据备份与恢复)
- [升级指南](#升级指南)

---

## 🎯 系统概述

### Langfuse 是什么？

Langfuse 是一个开源的 LLM 工程平台，提供以下核心功能：

- **追踪与监控**: 记录和可视化 LLM 应用的每一次调用
- **提示词管理**: 版本控制、A/B 测试、提示词优化
- **评估与标注**: 自动化和人工评估 LLM 输出质量
- **数据集管理**: 构建测试数据集，持续评估模型性能
- **成本分析**: 追踪 Token 使用和 API 调用成本

### 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Langfuse 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐        ┌──────────────┐                   │
│  │ Langfuse Web │───────▶│Langfuse Worker│                  │
│  │  (端口 3000) │        │  (端口 3030)  │                  │
│  └──────┬───────┘        └──────┬────────┘                  │
│         │                       │                            │
│         ▼                       ▼                            │
│  ┌──────────────┐        ┌──────────────┐                   │
│  │  PostgreSQL  │        │  ClickHouse  │                   │
│  │  (端口 5432) │        │  (端口 8123) │                   │
│  │  关系型数据   │        │  列式数据库   │                   │
│  └──────────────┘        └──────────────┘                   │
│         │                       │                            │
│         └───────────┬───────────┘                            │
│                     ▼                                        │
│              ┌──────────────┐                                │
│              │    Redis     │                                │
│              │  (端口 6379) │                                │
│              │  缓存/队列    │                                │
│              └──────────────┘                                │
│                     │                                        │
│                     ▼                                        │
│              ┌──────────────┐                                │
│              │    MinIO     │                                │
│              │  (端口 9090) │                                │
│              │  对象存储     │                                │
│              └──────────────┘                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 组件说明

| 组件 | 职责 | 资源需求 | 端口 |
|------|------|---------|------|
| **langfuse-web** | Web UI 和 REST API | 2GB 内存 | 3000 |
| **langfuse-worker** | 后台任务处理 | 2GB 内存 | 3030 |
| **PostgreSQL** | 元数据存储 | 2GB 内存, 20GB 磁盘 | 5432 |
| **ClickHouse** | 追踪数据存储 | 4GB 内存, 100GB 磁盘 | 8123, 9000 |
| **Redis** | 缓存和队列 | 1GB 内存 | 6379 |
| **MinIO** | 对象存储 | 1GB 内存, 50GB 磁盘 | 9090, 9091 |

**推荐配置**: 
- **最小配置**: 4 核 CPU, 8GB 内存, 100GB 磁盘
- **推荐配置**: 8 核 CPU, 16GB 内存, 200GB 磁盘
- **高负载配置**: 16 核 CPU, 32GB 内存, 500GB 磁盘

---

## ✅ 前置要求

### 1. 操作系统

支持以下操作系统：

- ✅ Linux (Ubuntu 22.04+, CentOS 8+, Debian 11+)
- ✅ macOS 12+ (使用 Docker Desktop)
- ✅ Windows 10/11 (使用 WSL2 + Docker Desktop)

### 2. 软件依赖

#### 必需软件

```bash
# Git (用于克隆仓库)
git --version  # 需要 2.0+

# Docker (容器运行时)
docker --version  # 需要 20.10+

# Docker Compose (容器编排)
docker compose version  # 需要 2.0+
```

#### 安装 Docker 和 Docker Compose

**Ubuntu/Debian:**

```bash
# 更新包索引
sudo apt-get update

# 安装依赖
sudo apt-get install -y ca-certificates curl

# 添加 Docker GPG 密钥
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# 添加 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 验证安装
sudo docker run hello-world
```

**macOS/Windows:**

下载并安装 [Docker Desktop](https://www.docker.com/products/docker-desktop/)

### 3. 网络要求

- **外网访问**: 需要能访问 Docker Hub 拉取镜像
- **端口开放**: 确保以下端口未被占用
  - `3000`: Langfuse Web 界面
  - `9090`: MinIO API (可选，如需外部上传媒体文件)
  - `9091`: MinIO 管理控制台 (本机访问)

### 4. 防火墙配置（云服务器）

如果在云服务器部署，需要配置安全组/防火墙规则：

```bash
# 允许 Langfuse Web 访问
允许入站: TCP 3000 (来源: 0.0.0.0/0 或指定 IP)

# 允许 MinIO API 访问（可选）
允许入站: TCP 9090 (来源: 0.0.0.0/0 或指定 IP)

# 建议禁止其他端口的外部访问
拒绝入站: TCP 5432, 6379, 8123, 9000, 9001, 3030
```

---

## 🚀 快速开始

### 步骤 1: 克隆仓库

```bash
# 克隆代码
git clone https://github.com/FlyAIBox/Agent_In_Action.git

# 进入目录
cd 04-agent-evaluation/langfuse/docker
```

### 步骤 2: 配置环境变量（重要！）

创建 `.env` 文件（强烈推荐）：

```bash
# 复制示例配置
cp env.dev.example .env

# 编辑配置文件
vim .env
```

**最小必要配置 (`.env` 文件内容):**

```bash
# =============================================================================
# Langfuse 核心配置
# =============================================================================

# 1. 数据库密码（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
POSTGRES_PASSWORD=postgres
CLICKHOUSE_PASSWORD=clickhouse

# 2. 加密密钥（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
# 生成方式: openssl rand -hex 32
ENCRYPTION_KEY=0000000000000000000000000000000000000000000000000000000000000000

# 3. 会话密钥（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
# 生成方式: openssl rand -base64 32
NEXTAUTH_SECRET=mysecret

# 4. 加密盐值（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
# 生成方式: openssl rand -base64 32
SALT=mysalt

# 5. Redis 密码（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
# 生成方式: openssl rand -base64 24
REDIS_AUTH=myredissecret

# 6. MinIO 密码（必改！）
# ⚠️ 当前为默认值，生产环境必须修改！
# 生成方式: openssl rand -base64 16
# 要求: 最少 8 个字符
MINIO_ROOT_PASSWORD=miniosecret

# =============================================================================
# 可选配置
# =============================================================================
# 无头初始化（自动创建管理员账户）
LANGFUSE_INIT_USER_EMAIL=admin@example.com
LANGFUSE_INIT_USER_PASSWORD=your_admin_password
LANGFUSE_INIT_USER_NAME=Admin
LANGFUSE_INIT_ORG_NAME=AGENT AI
LANGFUSE_INIT_PROJECT_NAME=Agent101
```

**生成安全密钥命令:**

```bash
# 生成 ENCRYPTION_KEY (64位十六进制)
openssl rand -hex 32

# 生成 NEXTAUTH_SECRET (Base64)
openssl rand -base64 32

# 生成随机密码
openssl rand -base64 24
```

### 步骤 3: 启动服务

```bash
# 启动所有服务（前台运行，查看日志）
docker compose up

# 或者后台运行
docker compose up -d

# 查看日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f langfuse-web
```

**启动过程说明:**

1. **拉取镜像** (首次运行，约 2-5 分钟)
   ```
   Pulling postgres ... done
   Pulling redis    ... done
   Pulling clickhouse ... done
   Pulling minio    ... done
   Pulling langfuse-worker ... done
   Pulling langfuse-web ... done
   ```

2. **初始化数据库** (约 1-2 分钟)
   - PostgreSQL 数据库表创建
   - ClickHouse 数据库表创建
   - MinIO 存储桶创建

3. **服务就绪** (看到以下日志表示成功)
   ```
   langfuse-web-1    | Ready started server on 0.0.0.0:3000, url: http://192.168.172.128:3000
   ```

### 步骤 4: 访问 Langfuse

打开浏览器访问: **http://192.168.172.128:3000**

**首次访问:**

- 如果配置了无头初始化，直接使用配置的邮箱密码登录
- 如果未配置，会自动跳转到注册页面，创建第一个用户

**访问 MinIO 管理控制台 (可选):**

访问: **http://localhost:9091**

- 用户名: `minio` (或您在 `.env` 中设置的 `MINIO_ROOT_USER`)
- 密码: 您在 `.env` 中设置的 `MINIO_ROOT_PASSWORD`

### 步骤 5: 创建用户、组织和项目

#### 方式一: 使用无头初始化（推荐）

如果您在 `.env` 文件中配置了无头初始化参数，系统会在首次启动时自动创建：

- ✅ 管理员用户账户
- ✅ 组织（Organization）
- ✅ 项目（Project）
- ✅ API 密钥（Public Key 和 Secret Key）

**配置示例:**

```bash
# .env 文件
LANGFUSE_INIT_USER_EMAIL=admin@example.com
LANGFUSE_INIT_USER_PASSWORD=your_admin_password
LANGFUSE_INIT_USER_NAME=Admin
LANGFUSE_INIT_ORG_NAME=AGENT AI
LANGFUSE_INIT_PROJECT_NAME=Agent101
```

启动后，直接使用配置的邮箱和密码登录即可。

#### 方式二: 手动创建（Web 界面）

如果未配置无头初始化，需要手动创建：

##### 5.1 创建用户账户

1. **首次访问**: 打开浏览器访问 `http://192.168.172.128:3000`（或您的服务器地址）
2. **注册账户**: 
   - 系统会自动跳转到注册页面
   - 填写以下信息：
     - **Email**: 您的邮箱地址（如 `admin@example.com`）
     - **Password**: 设置登录密码
     - **Name**: 您的姓名（如 `Admin`）
3. **完成注册**: 点击 "Sign Up" 按钮
4. **登录系统**: 使用注册的邮箱和密码登录

##### 5.2 创建组织（Organization）
![LangFuse-创建组织](../img/01-LangFuse-创建组织.png)
1. 第一次登录后，会默认直接进入**Organizations**。如果没有，请继续第二步。
2. **选择组织**: 在左侧菜单选择 **Organizations**
3. **创建组织**:
   - 点击 **"New Organization"** 按钮
   - 填写组织信息：
     - **Name**: 组织名称（如 `AGENT AI`）
   - 点击 **"Create"** 完成创建
4. **Invite Members**: 默认会关联管理员。可以 **"Next"** 进入下一步。 

##### 5.3 创建项目（Project）
![LangFuse-创建项目](../img/02-LangFuse-创建项目.png)
1. **进入项目页面**: 
   - 默认直接进入创建项目页面，或点击左侧菜单的 **Projects**
2. **创建项目**:
   - 点击 **"New Project"** 按钮
   - 填写项目信息：
     - **Name**: 项目名称（如 `Agent101`）
   - 点击 **"Create"** 完成创建
3. **选择项目**: 创建后，在项目列表中点击项目名称进入项目详情页

**注意**: 每个项目都有独立的 API 密钥，用于追踪该项目的 LLM 调用数据。

---

### 步骤 6: 获取 API 密钥
![LangFuse-创建APIKeys](../img/03-LangFuse-创建APIKeys.png)

API 密钥用于在您的应用程序中集成 Langfuse SDK，追踪 LLM 调用数据。

#### 6.1 获取项目 API 密钥

1. **进入项目设置**:
   - 登录 Langfuse Web 界面
   - 选择要使用的项目（点击左侧菜单的 **Projects**，然后选择项目）
   - 进入项目后，点击左侧菜单的 **Settings** → **API Keys**

2. **查看 API 密钥**:
   - 在 API Keys 页面，点击您会 **Create API Keys** 看到以下信息：
     - **Public Key** (公钥): 格式为 `pk-lf-xxxxx-xxxxx-xxxxx-xxxxx`
     - **Secret Key** (私钥): 格式为 `sk-lf-xxxxx-xxxxx-xxxxx-xxxxx`
     - **Host** (服务器地址): 您的 Langfuse 服务器地址

3. **复制密钥**:
   - 点击 **"Copy"** 按钮复制密钥到剪贴板

**示例 API 密钥信息:**

```bash
# 在您的应用程序中使用这些密钥
LANGFUSE_PUBLIC_KEY = "pk-lf-72a365cd-b256-48b6-9dfc-3c41f65c97f1"
LANGFUSE_SECRET_KEY = "sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9"
LANGFUSE_BASE_URL = "http://192.168.172.128:3000"
```

#### 6.2 配置 LANGFUSE_BASE_URL

**LANGFUSE_BASE_URL** 是您的 Langfuse 服务器地址，根据部署环境不同：

- **本地开发**: `http://192.168.172.128:3000`
- **局域网访问**: `http://<服务器内网IP>:3000`（如 `http://192.168.172.128:3000`）
- **公网访问**: `http://<服务器公网IP>:3000` 或 `https://langfuse.yourdomain.com`

**获取服务器 IP 地址:**

```bash
# Linux/macOS
# 查看内网 IP
ip addr show | grep "inet " | grep -v 127.0.0.1

# 或使用
hostname -I

# 查看公网 IP（如果在云服务器）
curl ifconfig.me
```

#### 6.3 在应用程序中使用 API 密钥

**Python 示例:**

```python
from langfuse import Langfuse

# 初始化 Langfuse 客户端
langfuse = Langfuse(
    public_key="pk-lf-72a365cd-b256-48b6-9dfc-3c41f65c97f1",
    secret_key="sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9",
    host="http://192.168.172.128:3000"
)

# 追踪 LLM 调用
trace = langfuse.trace(
    name="my-trace",
    user_id="user-123"
)
```

**JavaScript/TypeScript 示例:**

```typescript
import { Langfuse } from "langfuse";

// 初始化 Langfuse 客户端
const langfuse = new Langfuse({
  publicKey: "pk-lf-72a365cd-b256-48b6-9dfc-3c41f65c97f1",
  secretKey: "sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9",
  baseUrl: "http://192.168.172.128:3000"
});

// 追踪 LLM 调用
const trace = langfuse.trace({
  name: "my-trace",
  userId: "user-123"
});
```

#### 6.4 安全注意事项

⚠️ **重要安全提示**:

1. **保护 Secret Key**: 
   - Secret Key 具有完整访问权限，请勿泄露
   - 不要将 Secret Key 提交到代码仓库
   - 使用环境变量或密钥管理服务存储

2. **使用环境变量**:
   ```bash
   # .env 文件（不要提交到 Git）
   export LANGFUSE_PUBLIC_KEY="pk-lf-72a365cd-b256-48b6-9dfc-3c41f65c97f1"
   export LANGFUSE_SECRET_KEY="sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9"
   export LANGFUSE_BASE_URL="http://192.168.172.128:3000"
   ```

3. **定期轮换密钥**:
   - 在项目设置中可以创建新的 API 密钥
   - 删除不再使用的旧密钥

4. **权限管理**:
   - 不同项目使用不同的 API 密钥
   - 团队成员可以共享 Public Key，但 Secret Key 应限制访问

#### 6.5 验证 API 密钥

测试 API 密钥是否配置正确:

```bash
# 使用 curl 测试
curl -X GET "http://192.168.172.128:3000/api/public/health" \
  -H "Authorization: Bearer sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9"

# 或使用 Python
python -c "
from langfuse import Langfuse
langfuse = Langfuse(
    public_key='pk-lf-72a365cd-b256-48b6-9dfc-3c41f65c97f1',
    secret_key='sk-lf-d94a06ae-12e9-443a-bfb3-cf48d56e93f9',
    host='http://192.168.172.128:3000'
)
print('API 密钥验证成功！')
"
```

---

## 🔧 详细配置说明

### 环境变量完整列表

#### 核心认证配置

| 变量名 | 说明 | 默认值 | 必改 |
|--------|------|--------|------|
| `NEXTAUTH_URL` | 应用访问 URL | `http://192.168.172.128:3000` | 生产环境必改 |
| `NEXTAUTH_SECRET` | JWT 签名密钥 | `mysecret` | ✅ 是 |
| `DATABASE_URL` | PostgreSQL 连接串 | `postgresql://postgres:postgres@postgres:5432/postgres` | ✅ 是 (改密码) |
| `SALT` | 加密盐值 | `mysalt` | ✅ 是 |
| `ENCRYPTION_KEY` | AES-256 加密密钥 | `0000...` | ✅ 是 |

#### ClickHouse 配置

| 变量名 | 说明 | 默认值 | 必改 |
|--------|------|--------|------|
| `CLICKHOUSE_URL` | HTTP API 地址 | `http://clickhouse:8123` | 否 |
| `CLICKHOUSE_MIGRATION_URL` | 迁移连接地址 | `clickhouse://clickhouse:9000` | 否 |
| `CLICKHOUSE_USER` | 用户名 | `clickhouse` | 否 |
| `CLICKHOUSE_PASSWORD` | 密码 | `clickhouse` | ✅ 是 |
| `CLICKHOUSE_CLUSTER_ENABLED` | 集群模式 | `false` | 否 |

#### Redis 配置

| 变量名 | 说明 | 默认值 | 必改 |
|--------|------|--------|------|
| `REDIS_HOST` | 主机地址 | `redis` | 否 |
| `REDIS_PORT` | 端口 | `6379` | 否 |
| `REDIS_AUTH` | 密码 | `myredissecret` | ✅ 是 |
| `REDIS_TLS_ENABLED` | 启用 TLS | `false` | 否 |

#### MinIO / S3 配置

**事件数据存储:**

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `LANGFUSE_S3_EVENT_UPLOAD_BUCKET` | 存储桶名 | `langfuse` |
| `LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID` | 访问密钥 ID | `minio` |
| `LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY` | 访问密钥 | `miniosecret` ✅ 必改 |
| `LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT` | 内部端点 | `http://minio:9000` |

**媒体文件上传:**

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT` | 外部端点 | `http://localhost:9090` |
| `LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY` | 访问密钥 | `miniosecret` ✅ 必改 |

**批量导出:**

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `LANGFUSE_S3_BATCH_EXPORT_ENABLED` | 启用导出 | `false` |
| `LANGFUSE_S3_BATCH_EXPORT_EXTERNAL_ENDPOINT` | 下载端点 | `http://localhost:9090` |

#### 无头初始化配置

| 变量名 | 说明 | 用途 |
|--------|------|------|
| `LANGFUSE_INIT_USER_EMAIL` | 管理员邮箱 | 自动创建管理员账户 |
| `LANGFUSE_INIT_USER_PASSWORD` | 管理员密码 | 登录凭证 |
| `LANGFUSE_INIT_USER_NAME` | 管理员姓名 | 显示名称 |
| `LANGFUSE_INIT_ORG_NAME` | 组织名称 | 自动创建组织 |
| `LANGFUSE_INIT_PROJECT_NAME` | 项目名称 | 自动创建项目 |
| `LANGFUSE_INIT_PROJECT_PUBLIC_KEY` | 项目公钥 | 留空自动生成 |
| `LANGFUSE_INIT_PROJECT_SECRET_KEY` | 项目私钥 | 留空自动生成 |

#### 邮件服务配置

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `EMAIL_FROM_ADDRESS` | 发件人地址 | `noreply@yourdomain.com` |
| `SMTP_CONNECTION_URL` | SMTP 连接 URL | `smtp://user:pass@smtp.gmail.com:587` |

**配置邮件服务后可用功能:**
- 用户邀请邮件
- 密码重置邮件
- 系统告警通知

---

## 🔒 安全加固

### 生产环境安全检查清单

#### ✅ 1. 修改所有默认密码

```bash
# 检查以下变量是否已修改
POSTGRES_PASSWORD=postgres          # ❌ 不安全
CLICKHOUSE_PASSWORD=clickhouse      # ❌ 不安全
REDIS_AUTH=myredissecret            # ❌ 不安全
MINIO_ROOT_PASSWORD=miniosecret     # ❌ 不安全
NEXTAUTH_SECRET=mysecret            # ❌ 不安全
SALT=mysalt                         # ❌ 不安全
```

**建议密码策略:**
- 长度 ≥ 16 字符
- 包含大小写字母、数字、特殊字符
- 使用密码生成器生成

#### ✅ 2. 配置 HTTPS

**方式一: 使用 Nginx 反向代理**

创建 `nginx.conf`:

```nginx
server {
    listen 80;
    server_name langfuse.yourdomain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name langfuse.yourdomain.com;
    
    # SSL 证书配置
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    
    # 安全头部
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # 反向代理到 Langfuse
    location / {
        proxy_pass http://192.168.172.128:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**方式二: 使用 Caddy (自动 HTTPS)**

创建 `Caddyfile`:

```caddy
langfuse.yourdomain.com {
    reverse_proxy localhost:3000
}
```

启动 Caddy:

```bash
caddy run --config Caddyfile
```

**更新 Langfuse 配置:**

```bash
# .env 文件中更新
NEXTAUTH_URL=https://langfuse.yourdomain.com
```

#### ✅ 3. 限制网络访问

**仅开放必要端口:**

```bash
# 防火墙配置 (Ubuntu/UFW)
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable

# 云服务器安全组
# 仅允许: TCP 443 (0.0.0.0/0)
# 拒绝: TCP 3000, 9090, 5432, 6379, 8123, 9000
```

**Docker 网络隔离:**

在 `docker-compose.yml` 中使用内部网络：

```yaml
networks:
  langfuse-internal:
    internal: true
  langfuse-external:

services:
  langfuse-web:
    networks:
      - langfuse-internal
      - langfuse-external
  
  postgres:
    networks:
      - langfuse-internal  # 仅内部访问
```

#### ✅ 4. 启用 Redis TLS

生成证书:

```bash
# 生成 CA 证书
openssl req -x509 -nodes -newkey rsa:4096 -keyout ca.key -out ca.crt -days 3650

# 生成 Redis 服务器证书
openssl req -nodes -newkey rsa:4096 -keyout redis.key -out redis.csr
openssl x509 -req -in redis.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out redis.crt -days 3650
```

更新配置:

```yaml
# docker-compose.yml
redis:
  volumes:
    - ./certs:/certs:ro
  command: >
    --requirepass ${REDIS_AUTH}
    --tls-port 6379
    --port 0
    --tls-cert-file /certs/redis.crt
    --tls-key-file /certs/redis.key
    --tls-ca-cert-file /certs/ca.crt

# .env
REDIS_TLS_ENABLED=true
REDIS_TLS_CA=/certs/ca.crt
REDIS_TLS_CERT=/certs/redis.crt
REDIS_TLS_KEY=/certs/redis.key
```

#### ✅ 5. 数据加密

**启用数据库加密:**

```bash
# PostgreSQL 透明数据加密
# 需要 PostgreSQL 企业版或第三方扩展

# ClickHouse 列级加密
# 在 Langfuse 中已通过 ENCRYPTION_KEY 实现
```

#### ✅ 6. 定期安全审计

```bash
# 检查容器安全漏洞
docker scout cves langfuse/langfuse:3
docker scout cves postgres:17
docker scout cves clickhouse/clickhouse-server

# 检查开放端口
sudo netstat -tuln | grep LISTEN

# 检查 Docker 容器日志
docker compose logs --tail=100 | grep -i error
```

---

## ❓ 常见问题

### 1. 容器无法启动

**症状**: `docker compose up` 报错

**可能原因及解决方案:**

#### 端口被占用

```bash
# 检查端口占用
sudo lsof -i :3000
sudo lsof -i :5432

# 关闭占用进程或修改端口
# 在 docker-compose.yml 中修改:
ports:
  - "3001:3000"  # 改为其他端口
```

#### 磁盘空间不足

```bash
# 检查磁盘空间
df -h

# 清理 Docker 资源
docker system prune -a --volumes

# 查看 Docker 磁盘使用
docker system df
```

#### 内存不足

```bash
# 检查内存使用
free -h

# 增加 Docker Desktop 内存限制
# macOS/Windows: Docker Desktop → Settings → Resources → Memory

# Linux: 检查系统内存
cat /proc/meminfo
```

### 2. 无法访问 Langfuse Web 界面

**症状**: 浏览器无法打开 http://192.168.172.128:3000

**解决方案:**

```bash
# 1. 检查服务状态
docker compose ps

# 2. 查看日志
docker compose logs langfuse-web

# 3. 等待服务完全启动（约 2-3 分钟）
# 看到 "Ready started server" 日志后再访问

# 4. 如果是云服务器，检查防火墙
sudo ufw status
# 确保 3000 端口已开放

# 5. 使用服务器 IP 访问
http://<服务器公网IP>:3000
```

### 3. 数据库连接失败

**症状**: 日志中出现 "could not connect to database"

**解决方案:**

```bash
# 1. 检查 PostgreSQL 健康状态
docker compose ps postgres

# 2. 手动测试数据库连接
docker compose exec postgres psql -U postgres -c "SELECT 1;"

# 3. 检查密码配置是否一致
# 确保 docker-compose.yml 和 .env 中的密码匹配

# 4. 重启数据库服务
docker compose restart postgres
docker compose restart langfuse-web langfuse-worker
```

### 4. ClickHouse 性能问题

**症状**: 追踪数据查询缓慢

**解决方案:**

```bash
# 1. 增加 ClickHouse 内存
# 在 docker-compose.yml 中添加:
clickhouse:
  environment:
    CLICKHOUSE_MAX_MEMORY_USAGE: 8000000000  # 8GB

# 2. 检查磁盘 I/O
iostat -x 1

# 3. 优化数据分区
# ClickHouse 自动按时间分区，无需手动配置

# 4. 定期清理旧数据
# 在 Langfuse UI: Settings → Data Retention
```

### 5. MinIO 媒体上传失败

**症状**: 上传图片/视频时报错

**原因**: MinIO 外部端点配置错误

**解决方案:**

```bash
# 1. 检查 MinIO 是否可访问
curl http://localhost:9090/minio/health/live

# 2. 更新外部端点配置
# 本地部署:
LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT=http://localhost:9090

# 云服务器部署:
LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT=http://<服务器公网IP>:9090

# 3. 确保 9090 端口已开放
sudo ufw allow 9090/tcp

# 4. 重启服务
docker compose restart langfuse-web langfuse-worker
```

### 6. 数据丢失问题

**症状**: 重启后数据消失

**原因**: Volume 未正确挂载

**解决方案:**

```bash
# 1. 检查 Volume 是否存在
docker volume ls | grep langfuse

# 2. 检查 Volume 挂载
docker compose config | grep volumes

# 3. 不要使用 -v 参数停止容器
docker compose down     # ✅ 正确
docker compose down -v  # ❌ 会删除 Volume！

# 4. 恢复数据（如果有备份）
# 参考"数据备份与恢复"章节
```

### 7. 日志显示 "准备时间过长"

**症状**: 启动超过 5 分钟仍未就绪

**解决方案:**

```bash
# 1. 检查是否首次运行（需要初始化数据库）
# 首次启动约需 3-5 分钟

# 2. 检查数据库迁移状态
docker compose logs langfuse-worker | grep migration

# 3. 如果迁移失败，清空数据库重试
docker compose down -v
docker compose up

# 4. 查看资源使用
docker stats

# 5. 如果 CPU/内存不足，升级机器配置
```

---

## 🚀 性能优化

### 1. 数据库优化

#### PostgreSQL 调优

在 `docker-compose.yml` 中添加:

```yaml
postgres:
  command:
    - postgres
    - -c
    - shared_buffers=2GB
    - -c
    - effective_cache_size=6GB
    - -c
    - maintenance_work_mem=512MB
    - -c
    - max_connections=200
    - -c
    - random_page_cost=1.1
    - -c
    - effective_io_concurrency=200
```

#### ClickHouse 调优

```yaml
clickhouse:
  ulimits:
    nofile:
      soft: 262144
      hard: 262144
  environment:
    CLICKHOUSE_MAX_MEMORY_USAGE: 8000000000
    CLICKHOUSE_MAX_THREADS: 8
```

### 2. Redis 优化

```yaml
redis:
  command: >
    --requirepass ${REDIS_AUTH}
    --maxmemory 2gb
    --maxmemory-policy allkeys-lru
    --save ""
```

### 3. 网络优化

```yaml
services:
  langfuse-web:
    networks:
      langfuse:
        ipv4_address: 172.20.0.10

networks:
  langfuse:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 4. 资源限制

```yaml
services:
  langfuse-web:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G
```

### 5. 数据摄入优化

```bash
# .env 文件
# 增加批量写入间隔（提高吞吐量，但增加延迟）
LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS=5000

# 增加队列延迟（减少数据库写入频率）
LANGFUSE_INGESTION_QUEUE_DELAY_MS=2000
```

---

## 💾 数据备份与恢复

### 自动备份脚本

创建 `backup.sh`:

```bash
#!/bin/bash
# Langfuse 数据备份脚本

BACKUP_DIR="/backup/langfuse"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 1. 备份 PostgreSQL
echo "备份 PostgreSQL..."
docker compose exec -T postgres pg_dump -U postgres postgres | gzip > $BACKUP_DIR/postgres_$DATE.sql.gz

# 2. 备份 ClickHouse
echo "备份 ClickHouse..."
docker compose exec -T clickhouse clickhouse-client --query="BACKUP DATABASE default TO Disk('backups', '$DATE')"

# 3. 备份 MinIO 数据
echo "备份 MinIO..."
docker run --rm -v langfuse_minio_data:/data -v $BACKUP_DIR:/backup alpine \
  tar czf /backup/minio_$DATE.tar.gz -C /data .

# 4. 备份配置文件
echo "备份配置文件..."
cp docker-compose.yml $BACKUP_DIR/docker-compose_$DATE.yml
cp .env $BACKUP_DIR/env_$DATE.backup

# 5. 删除 7 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR"
```

设置定时任务:

```bash
# 添加到 crontab
chmod +x backup.sh
crontab -e

# 每天凌晨 2 点备份
0 2 * * * /path/to/backup.sh >> /var/log/langfuse-backup.log 2>&1
```

### 数据恢复

#### 恢复 PostgreSQL

```bash
# 停止服务
docker compose down

# 启动 PostgreSQL
docker compose up -d postgres

# 等待数据库就绪
sleep 10

# 恢复数据
gunzip < /backup/langfuse/postgres_20250122_020000.sql.gz | \
  docker compose exec -T postgres psql -U postgres postgres

# 重启所有服务
docker compose up -d
```

#### 恢复 ClickHouse

```bash
# 恢复数据
docker compose exec clickhouse clickhouse-client \
  --query="RESTORE DATABASE default FROM Disk('backups', '20250122_020000')"
```

#### 恢复 MinIO

```bash
# 停止服务
docker compose down

# 恢复数据
docker run --rm -v langfuse_minio_data:/data -v /backup/langfuse:/backup alpine \
  tar xzf /backup/minio_20250122_020000.tar.gz -C /data

# 重启服务
docker compose up -d
```

---

## 🔄 升级指南

### 检查当前版本

```bash
# 查看镜像标签
docker compose images

# 查看 Langfuse 版本
docker compose exec langfuse-web cat /app/package.json | grep version
```

### 升级步骤

```bash
# 1. 停止服务
docker compose down

# 2. 备份数据（重要！）
./backup.sh

# 3. 拉取最新镜像
docker compose pull

# 4. 启动服务（自动运行数据库迁移）
docker compose up -d

# 5. 查看日志，确认迁移成功
docker compose logs -f langfuse-worker | grep migration

# 6. 验证功能
curl http://192.168.172.128:3000/api/public/health
```

### 版本回滚

```bash
# 1. 停止服务
docker compose down

# 2. 修改镜像版本
# docker-compose.yml:
image: docker.io/langfuse/langfuse:2  # 回滚到 v2

# 3. 恢复数据库备份（如果数据结构有变化）
# ...

# 4. 启动服务
docker compose up -d
```

### 版本迁移注意事项

**v2 → v3 重大变更:**

1. **新增 ClickHouse 依赖**: 需要配置 ClickHouse 环境变量
2. **数据迁移**: 首次启动会自动将数据从 PostgreSQL 迁移到 ClickHouse（可能耗时较长）
3. **配置变更**: 部分环境变量名称改变，需更新 `.env` 文件

---

## 📚 扩展阅读

### 官方文档

- [Langfuse 官方文档](https://langfuse.com/docs)
- [自托管部署指南](https://langfuse.com/self-hosting)
- [Docker Compose 部署](https://langfuse.com/self-hosting/deployment/docker-compose)
- [Kubernetes 部署](https://langfuse.com/self-hosting/deployment/kubernetes)

### SDK 集成

- [Python SDK](https://langfuse.com/docs/sdk/python)
- [JavaScript/TypeScript SDK](https://langfuse.com/docs/sdk/typescript)
- [LangChain 集成](https://langfuse.com/docs/integrations/langchain)
- [LlamaIndex 集成](https://langfuse.com/docs/integrations/llama-index)

### 最佳实践

- [提示词管理](https://langfuse.com/docs/prompts)
- [评估与测试](https://langfuse.com/docs/scores)
- [数据集管理](https://langfuse.com/docs/datasets)
- [成本追踪](https://langfuse.com/docs/cost)

---

## 🆘 获取支持

### 社区支持

- **GitHub Issues**: https://github.com/langfuse/langfuse/issues
- **Discord 社区**: https://discord.gg/7NXusRtqYU
- **官方论坛**: https://langfuse.com/community

### 商业支持

- **企业版**: 提供专业技术支持和 SLA 保障
- **咨询服务**: 架构设计、性能优化、安全加固
- **联系方式**: https://langfuse.com/enterprise

---

## 📝 更新日志

| 日期 | 版本 | 变更说明 |
|------|------|---------|
| 2025-01-22 | 1.0 | 初始版本，基于 Langfuse v3 |

---

## ⚖️ 许可证

本文档采用 MIT 许可证。Langfuse 项目采用 MIT 许可证。

---

**祝您使用愉快！如有问题，欢迎反馈。** 🎉

